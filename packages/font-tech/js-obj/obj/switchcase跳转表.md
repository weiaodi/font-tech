编译器对 `switch case` 的优化核心是通过**构建“跳转表”（Jump Table）或“查找表”（Lookup Table）**，将原本需要逐个比较的线性逻辑（O(n)）转换为直接索引定位的常数时间逻辑（O(1)）。这种优化的实现方式和适用条件，本质上取决于 `case` 条件的“特征”是否适合构建高效的映射关系。

### 一、编译器如何优化 `switch case`？

以 C/C++ 编译器（如 GCC、Clang）或 JavaScript 引擎（如 V8）的优化逻辑为例，核心思路是：  
当 `case` 条件满足“可映射为连续/紧凑的整数范围”时，编译器会在编译期（或 JIT 编译时）生成一个**跳转表**——这是一个数组，数组的索引对应 `case` 的值（或经过计算的偏移量），数组的元素是对应 `case` 分支的代码地址（或执行入口）。

当代码执行到 `switch` 时，只需：

1. 对输入值做简单计算（如减去最小值，得到相对索引）；
2. 用索引直接访问跳转表，获取目标分支的代码地址；
3. 直接跳转到该地址执行，无需逐个比较 `case` 条件。

例如，对于这样的 `switch`：

```cpp
switch (num) {
  case 1: doA(); break;
  case 2: doB(); break;
  case 3: doC(); break;
}
```

编译器会发现 `case` 值是连续的整数（1-3），于是生成一个跳转表：

- 索引 0 → 对应 `case 1` 的代码地址（`doA()`）
- 索引 1 → 对应 `case 2` 的代码地址（`doB()`）
- 索引 2 → 对应 `case 3` 的代码地址（`doC()`）

执行时，只需计算 `index = num - 1`，直接通过 `index` 从表中取地址跳转，一步到位，时间复杂度 O(1)。

### 二、什么情况下能实现这种优化？

编译器是否生成跳转表（实现 O(1) 优化），取决于 `case` 条件是否满足以下特征：

1. **`case` 值是“可转换为整数的类型”**  
   跳转表的索引本质是整数，因此 `case` 条件必须是整数（int、char、枚举等）或能稳定转换为整数的类型（如短字符串，可通过哈希转换为整数）。

   - 例如：`case 10`、`case 'a'`（ASCII 码是整数）、`case Enum.A`（枚举值本质是整数）都符合条件；
   - 而复杂对象、动态字符串（长度长或哈希不稳定）、浮点数（精度问题可能导致索引计算错误）通常不适合。

2. **`case` 值的范围“紧凑且连续（或接近连续）”**  
   跳转表的大小由 `case` 值的“最大值 - 最小值 + 1”决定。如果范围过大（比如 `case 1` 和 `case 100000`），跳转表会变得非常稀疏（需要 10 万个元素，但只用到 2 个），浪费内存，编译器会放弃优化。

   - 例如：`case` 值为 5、6、7、8（范围 4，大小合适）→ 适合跳转表；
   - 例如：`case` 值为 1、100、10000（范围 9999，稀疏）→ 不适合，编译器仍用 O(n) 比较。

3. **`case` 数量“足够多”，值得构建跳转表**  
   如果 `case` 数量极少（如 2-3 个），逐个比较（O(n)）的开销可能比访问跳转表更低（跳转表需要额外的索引计算和内存访问），编译器会选择不优化。

   - 例如：10 个以上连续 `case` → 倾向于生成跳转表；
   - 例如：2 个 `case` → 直接用 `if-else` 式比较更高效，不优化。

4. **`case` 条件是“常量”，且在编译期可确定**  
   跳转表需要在编译期（或 JIT 编译时）确定所有 `case` 值的范围和映射关系。如果 `case` 条件是变量或动态计算的表达式（如 `case x + y`，x、y 运行时才确定），编译器无法提前构建跳转表，只能用 O(n) 比较。

### 总结

编译器对 `switch case` 的 O(1) 优化，本质是通过“跳转表”将离散的 `case` 条件转换为连续的索引映射，核心依赖 `case` 值的“整数特性、范围紧凑性、数量规模”和“编译期可确定性”。  
这种优化在 `case` 是连续整数、数量适中（如 5-20 个）的场景下最有效；而当 `case` 值分散、类型复杂或数量极少时，编译器会退回 O(n) 的逐个比较逻辑。

相比之下，对象键值对检索（表驱动）因依赖哈希表或“快属性”的索引访问，天然具备更稳定的 O(1) 特性，且无需依赖编译器的优化条件，这也是表驱动在工程实践中更可靠的原因之一。
