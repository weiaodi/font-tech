Vue 2 的 diff 算法核心逻辑是 **分层对比 + 双指针优化 + key 高效匹配**，目标是用最小成本更新 DOM。以下是简化版逻辑和示例：

### **一、核心逻辑（一句话总结）**

1. **同级对比**：只对比同一层级的节点，不跨层级（如只对比父节点的子节点，不对比孙子节点）。
2. **双指针快速匹配**：用两个指针分别从新旧子节点的 **头部和尾部** 开始对比，快速处理四种边界情况（头头、尾尾、头尾、尾头）。
3. **基于 key 的精准移动**：通过 `key` 标识节点唯一性，避免遍历所有节点，直接定位需要移动/更新的节点。
4. **兜底策略**：若上述匹配失败，遍历旧节点用 `key` 建立映射表，查找新节点的位置，最小化 DOM 操作。

### **二、具体执行步骤（无代码版）**

#### **1. 首次渲染：生成虚拟 DOM 并创建真实 DOM**

- 例：组件首次渲染时，根据模板生成虚拟 DOM（如 `div` 节点包含子节点 `p` 和 `span`），然后一次性创建真实 DOM 插入页面。

#### **2. 更新时：对比新旧虚拟 DOM**

假设旧虚拟 DOM 子节点为 `[A, B, C, D]`，新子节点为 `[B, A, C, E]`，`key` 分别为 `a`、`b`、`c`、`d`、`e`。

##### **步骤 1：双指针初始化**

- 旧头指针（`oldStart`）指向 `A`（`key=a`），旧尾指针（`oldEnd`）指向 `D`（`key=d`）。
- 新头指针（`newStart`）指向 `B`（`key=b`），新尾指针（`newEnd`）指向 `E`（`key=e`）。

##### **步骤 2：头头对比（失败）**

- 旧头节点 `A`（`key=a`）与新头节点 `B`（`key=b`）标签或 `key` 不同 → 不匹配，进入下一步。

##### **步骤 3：尾尾对比（失败）**

- 旧尾节点 `D`（`key=d`）与新尾节点 `E`（`key=e`）标签或 `key` 不同 → 不匹配，进入下一步。

##### **步骤 4：头尾对比（失败）**

- 旧头节点 `A`（`key=a`）与新尾节点 `E`（`key=e`）不匹配 → 进入下一步。

##### **步骤 5：尾头对比（成功）**

- 旧尾节点 `D`（`key=d`）与新头节点 `B`（`key=b`）不匹配 → 所有边界对比失败，进入 **兜底策略**。

##### **步骤 6：兜底策略：建立旧节点 key 映射表**

- 遍历旧节点 `[A, B, C, D]`，用 `key` 生成映射表：`{a: A, b: B, c: C, d: D}`。
- 遍历新节点 `[B, A, C, E]`，用 `key` 查找旧节点位置：
  - **`B`（`key=b`）**：在旧节点中存在，位置为旧头指针后一位（索引 1）→ 将其移动到新头指针位置（索引 0），旧头指针后移。
  - **`A`（`key=a`）**：在旧节点中存在，位置为旧头指针（索引 0）→ 已处理过，无需移动。
  - **`C`（`key=c`）**：位置不变，无需移动。
  - **`E`（`key=e`）**：旧节点中不存在 → 新建节点，插入到尾部。
- 最终操作：移动 `B` 到头部，删除旧节点 `D`，新增 `E`。

##### **步骤 7：应用 DOM 操作**

- 真实 DOM 从 `A B C D` 变为 `B A C E`，仅移动 `B`、删除 `D`、新增 `E`，其他节点复用。

### **三、关键优化点**

1. **只对比同级节点**：避免跨层级递归，大幅减少计算量（如父节点变化时，子节点直接整体替换）。
2. **优先对比头尾节点**：利用常见场景（如列表新增元素到尾部），快速完成匹配，减少循环次数。
3. **key 的必要性**：若节点无 `key`，diff 算法会退化为 **按顺序对比**，导致大量不必要的移动和更新（如列表中间插入元素时，后面所有节点会被重新渲染）。

**反例**：若节点无 `key`，旧子节点为 `[A, B, C]`，新子节点为 `[B, A, C]`，diff 算法会认为：

- 旧头 `A` 与新头 `B` 不匹配 → 删除 `A`，
- 旧头 `B` 与新头 `A` 不匹配 → 删除 `B`，
- 最后发现 `C` 存在 → 导致 `A` 和 `B` 被错误删除后重新创建，性能低下。

### **四、总结**

Vue 2 的 diff 算法通过 **分层对比 + 双指针边界匹配 + key 映射**，将复杂度控制在 O(n)，确保高效更新 DOM。核心思想是：**用最小成本找到节点位置变化，优先复用现有节点，最小化真实 DOM 操作**。
